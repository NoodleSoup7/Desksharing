<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>DeskBooker – 3-Tage-Buchung</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background:#f4f4f4; }
  #floorplan { position:relative; background:#fff; border:2px solid #333; display:inline-block; }
  .desk { position:absolute; background:green; border:2px solid #000; color:white; text-align:center; cursor:pointer; user-select:none; }
  .desk.booked { background:red; }
  .desk:hover { opacity:0.8; }
  #modal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:20px; border:2px solid #000; z-index:99; }
  #overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:98; }
  input, select, button { margin:5px; padding:8px; }
  .admin { background:#eee; padding:15px; margin-top:30px; border:1px solid #ccc; }
</style>
</head>
<body>

<h1>Arbeitsplatz-Buchung (max. 3 Tage im Voraus)</h1>

<label>Wähle Datum: </label>
<input type="date" id="selectedDate">

<div id="floorplan" style="width:1000px; height:700px;">
  <img src="https://via.placeholder.com/1000x700/cccccc/666666?text=Dein+Grundriss+(PNG+oder+PDF+als+Bild)" width="1000" height="700">
  <!-- Tische werden hier per JS eingefügt -->
</div>

<div id="overlay" onclick="closeModal()"></div>
<div id="modal">
  <h3>Tisch <span id="deskName"></span> buchen</h3>
  <p id="deskInfo"></p>
  <div id="fullDayOption">
    <button onclick="bookDesk('FULLDAY')">Ganztägig buchen</button>
  </div>
  <div id="hourlyOption" style="display:none;">
    Von <input type="time" id="startTime" value="09:00">
    Bis <input type="time" id="endTime" value="17:00">
    <button onclick="bookDesk('HOURLY')">Stundenweise buchen</button>
  </div>
  <button onclick="closeModal()">Abbrechen</button>
</div>

<!-- Admin-Bereich (Passwort: admin123) -->
<div class="admin">
  <h2>Admin-Bereich – Grundriss ändern</h2>
  <input type="file" id="floorplanUpload" accept="image/*,application/pdf">
  <button onclick="uploadFloorplan()">Grundriss hochladen (bleibt dauerhaft)</button>
  <p>→ Lädt das Bild kostenlos hoch und zeigt es sofort im Grundriss an</p>
  <div id="uploadStatus"></div>

  <hr>
  <h3>Neuen Tisch platzieren</h3>
  Name: <input id="newDeskName" value="Tisch Neu">
  Modus:
  <select id="newBookingMode">
    <option value="FULLDAY">Ganztägig</option>
    <option value="HOURLY">Stundenweise</option>
  </select>
  <button onclick="enablePlacingMode()">Platzieren aktivieren → dann auf Grundriss klicken</button>
</div>

<script>
// NEUE FUNKTION: Bild dauerhaft hochladen (imgbb.com – 100 % kostenlos & bleibt)
async function uploadFloorplan() {
  const file = document.getElementById('floorplanUpload').files[0];
  if (!file) return alert("Bitte Bild/PDF auswählen");

  const status = document.getElementById('uploadStatus');
  status.innerHTML = "Lädt hoch…";

  const formData = new FormData();
  formData.append('image', file);

  try {
    const resp = await fetch('https://api.imgbb.com/1/upload?key=8f0d27c2b4b4e5e9a0e8f7d6c5b4a3f2', {
      method: 'POST',
      body: formData
    });
    const data = await resp.json();
    if (data.success) {
      const url = data.data.url;
      document.querySelector('#floorplan img').src = url;
      localStorage.setItem('floorplanUrl', url); // bleibt im Browser gespeichert
      status.innerHTML = `<span style="color:green">✓ Erfolgreich hochgeladen! URL: <a href="${url}" target="_blank">öffnen</a></span>`;
    } else {
      status.innerHTML = "Fehler beim Hochladen";
    }
  } catch(e) {
    status.innerHTML = "Fehler: " + e.message;
  }
}

// Beim Laden der Seite → gespeichertes Bild wieder anzeigen
window.addEventListener('load', () => {
  const saved = localStorage.getItem('floorplanUrl');
  if (saved) {
    document.querySelector('#floorplan img').src = saved;
  }
});
</script>
// ==================== DATEN ====================
let desks = JSON.parse(localStorage.getItem('desks') || '[]');
let bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
let currentUser = prompt("Dein Name:", "Max Mustermann") || "Anonym";
let placingMode = false;

// ==================== INIT ====================
renderDesks();
setMinMaxDate();

// ==================== FUNKTIONEN ====================
function setMinMaxDate() {
  const today = new Date().toISOString().split('T')[0];
  const max = new Date();
  max.setDate(max.getDate() + 3);
  document.getElementById('selectedDate').min = today;
  document.getElementById('selectedDate').max = max.toISOString().split('T')[0];
  document.getElementById('selectedDate').value = today;
  document.getElementById('selectedDate').addEventListener('change', renderDesks);
}

function renderDesks() {
  const container = document.getElementById('floorplan');
  const date = document.getElementById('selectedDate').value;
  
  // alte Tische entfernen
  document.querySelectorAll('.desk').forEach(el => el.remove());
  
  desks.forEach(desk => {
    const div = document.createElement('div');
    div.className = 'desk';
    div.style.left = desk.x + 'px';
    div.style.top = desk.y + 'px';
    div.style.width = desk.w + 'px';
    div.style.height = desk.h + 'px';
    div.innerText = desk.name;
    div.dataset.id = desk.id;

    // gebucht?
    const booked = bookings.find(b => 
      b.deskId === desk.id && 
      b.date === date &&
      (!b.endTime || isOverlapping(b, date))
    );
    if (booked) {
      div.classList.add('booked');
      div.innerText += `\n${booked.user}`;
      div.title = `Belegt von ${booked.user}`;
    } else {
      div.title = 'Frei – klicken zum Buchen';
    }

    // Klick → Modal
    div.onclick = (e) => {
      e.stopPropagation();
      if (placingMode) return;
      if (booked) {
        alert(`Tisch bereits gebucht von ${booked.user}`);
        return;
      }
      openModal(desk);
    };

    // Drag & Resize (nur im Admin-Modus später)
    makeDraggableResizable(div);

    container.appendChild(div);
  });
}

function openModal(desk) {
  document.getElementById('deskName').innerText = desk.name;
  document.getElementById('deskInfo').innerText = `Datum: ${document.getElementById('selectedDate').value}`;
  document.getElementById('fullDayOption').style.display = 'block';
  document.getElementById('hourlyOption').style.display = desk.bookingMode === 'HOURLY' ? 'block' : 'none';
  document.getElementById('overlay').style.display = 'block';
  document.getElementById('modal').style.display = 'block';
  window.currentDesk = desk;
}

function closeModal() {
  document.getElementById('overlay').style.display = 'none';
  document.getElementById('modal').style.display = 'none';
}

function bookDesk(mode) {
  const desk = window.currentDesk;
  const date = document.getElementById('selectedDate').value;
  let start = null, end = null;
  if (mode === 'HOURLY') {
    start = document.getElementById('startTime').value;
    end = document.getElementById('endTime').value;
    if (!start || !end || start >= end) return alert("Ungültige Zeit");
    const minutes = (new Date(`2000/01/01 ${end}`) - new Date(`2000/01/01 ${start}`)) / 60000;
    if (minutes < 30 || minutes > 480) return alert("30min – 8h erlaubt");
  }

  // Doppelbuchung prüfen
  const conflict = bookings.find(b => 
    b.deskId === desk.id && 
    b.date === date &&
    (!b.endTime || (start && end && isTimeOverlap(start, end, b.startTime, b.endTime)))
  );
  if (conflict) return alert("Zeitraum bereits belegt!");

  bookings.push({
    deskId: desk.id,
    date,
    user: currentUser,
    startTime: start,
    endTime: end
  });
  localStorage.setItem('bookings', JSON.stringify(bookings));
  closeModal();
  renderDesks();
}

// ==================== ADMIN ====================
function checkAdmin() {
  if (document.getElementById('adminPw').value === 'admin123') {
    document.getElementById('adminPanel').style.display = 'block';
  }
}

function changeFloorplan() {
  const file = document.getElementById('floorplanUpload').files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = e => {
      document.querySelector('#floorplan img').src = e.target.result;
    };
    reader.readAsDataURL(file);
  }
}

function enablePlacingMode() {
  placingMode = true;
  alert("Jetzt auf den Grundriss klicken → neuer Tisch wird erstellt");
  document.getElementById('floorplan').style.cursor = 'crosshair';
}

document.getElementById('floorplan').addEventListener('click', (e) => {
  if (!placingMode) return;
  const rect = e.target.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  
  const newDesk = {
    id: Date.now().toString(),
    name: document.getElementById('newDeskName').value,
    x: x - 50,
    y: y - 30,
    w: 100,
    h: 60,
    bookingMode: document.getElementById('newBookingMode').value
  };
  desks.push(newDesk);
  localStorage.setItem('desks', JSON.stringify(desks));
  renderDesks();
  placingMode = false;
  document.getElementById('floorplan').style.cursor = 'default';
});

function clearAllData() {
  if (confirm("Alles löschen?")) {
    localStorage.clear();
    location.reload();
  }
}

// Drag & Resize für jeden Tisch
function makeDraggableResizable(el) {
  let startX, startY, startW, startH;
  el.onmousedown = (e) => {
    if (!document.getElementById('adminPanel').style.display === 'block') return; // nur Admin
    e.preventDefault();
    startX = e.clientX;
    startY = e.clientY;
    startW = el.offsetWidth;
    startH = el.offsetHeight;
    document.onmousemove = (ev) => {
      if (ev.buttons !== 1) return;
      if (ev.shiftKey) { // Resize mit Shift
        el.style.width = startW + (ev.clientX - startX) + 'px';
        el.style.height = startH + (ev.clientY - startY) + 'px';
      } else { // Drag
        el.style.left = el.offsetLeft + (ev.clientX - startX) + 'px';
        el.style.top = el.offsetTop + (ev.clientY - startY) + 'px';
        startX = ev.clientX;
        startY = ev.clientY;
      }
    };
    document.onmouseup = () => {
      document.onmousemove = document.onmouseup = null;
      // Speichern
      const id = el.dataset.id;
      const desk = desks.find(d => d.id === id);
      desk.x = parseInt(el.style.left);
      desk.y = parseInt(el.style.top);
      desk.w = el.offsetWidth;
      desk.h = el.offsetHeight;
      localStorage.setItem('desks', JSON.stringify(desks));
    };
  };
}

function isTimeOverlap(s1, e1, s2, e2) {
  return s1 < e2 && s2 < e1;
}
</script>
</body>
</html>
